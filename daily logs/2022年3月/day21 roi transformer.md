Learning RoI Transformer for Oriented Object Detection in Aerial Images

# Abstract

航空图像中的目标检测是计算机视觉中的一个活跃而又具有挑战性的任务，因为它具有鸟瞰视角、高度复杂的背景以及目标的多种多样的外观。尤其是当检测航空图像中密集的目标时，依赖于水平假设的常见目标检测方法往往会在感兴趣区域(ROI)和目标之间引入不匹配。这导致了最终目标分类置信度和定位精度之间的常见错位。在本文中，我们提出了一种感兴趣区域转换器来解决这些问题。ROI转换器的核心思想是将空间变换应用于感兴趣区域，并在有向包围盒(OBB)标注的监督下学习变换参数。ROI  Transformer是轻量级的，可以很容易地嵌入探测器中进行定向目标检测。只要将ROI转换器应用于光头，RCNN在两个常见且具有挑战性的航空数据集(即DOTA和HRSC2016)上取得了最先进的性能，但检测速度的降低可以忽略不计。当定向边界框注释可用时，我们的ROI转换器超过了可变形的位置敏感型ROI池。广泛的实验也验证了我们ROI  Transformer的灵活性和有效性。

# 1. Introduction

航空图像中的目标检测旨在定位地面上感兴趣的目标(如车辆、飞机)并识别它们的类别。随着越来越多的航空图像可用，航空图像中的目标检测一直是计算机视觉领域的一个具体而活跃的课题[3，29，36，6]。然而，与通常从水平角度拍摄的自然图像不同，航空图像通常是从鸟瞰视图拍摄的，这意味着航空图像中的对象总是任意定向的。此外，航空图像中目标的背景高度复杂、外观千变万化，进一步增加了目标检测的难度。这些问题通常采用定向和密集的目标检测任务[37，31，12]，这是一个新的但基础良好的任务，在过去十年中引起了许多关注[27，30，26，18，1]。

航空图像目标检测的许多最新进展都得益于R-CNN框架[9，8，32，2，29，38，6，12，16]。这些方法已经报道了良好的检测性能，它们使用水平边界框作为感兴趣区域(ROI)，然后依靠区域特征进行类别识别[2，29，6]。然而，如在[37，28]中所观察到的，这些水平感兴趣区(HROI)通常导致边界框和对象之间的未对齐。例如，如图1所示，由于航空图像中对象的定向和密集分布的特性，多个实例通常是拥挤的并且包含在一个HROI中。因此，训练检测器以提取目标特征和识别目标的准确定位通常变得困难。

代替使用水平边界框，已使用定向边界框来提供更准确的对象位置 [37,23,28]。为了在 RRoI  生成阶段实现高召回率，需要大量具有不同角度、比例和纵横比的锚点。这些方法在检测稀疏分布的物体方面展示了巨大的潜力 [26, 43, 27,  30]。然而，由于航拍图像中物体的方向高度多样化，使用具有有限方向的 RRoI 来获取准确的 RRoI  以与航拍图像中的所有对象进行配对通常是困难的。因此，具有尽可能多的方向和尺度的 RRoI 的精心设计通常会受到其在区域分类和定位阶段的高计算复杂性的影响。

由于常规网络中用于对象检测的常规操作  [8] 对旋转和尺度变化的泛化有限，因此在设计 RoI 和相应的提取特征时需要一些方向和尺度不变。为此，已提出空间变换器 [14] 和可变形卷积和 RoI 池化  [5]  来对几何变化进行建模。然而，它们主要是为一般几何变形而设计的，没有使用定向边界框标注。在航拍图像领域，只有刚性变形，有方向的边界框标注。因此，很自然地认为提取旋转不变区域特征并消除区域特征和对象之间的错位非常重要，特别是对于密集打包的对象。

在本文中，我们提出了一个名为 RoI Transformer 的模块，旨在通过有监督的 RRoI 学习和基于位置敏感对齐的特征提取，通过两阶段框架 [9, 8,  32, 4 , 10]。它由两部分组成。第一个是 RRoI Learner，它学习从 HRoI 到 RRoI 的转换。第二个是Rotated Position  Sensitive RoI Align，它从RRoI中提取旋转不变的特征，用于跟踪对象分类和位置回归。为了进一步提高效率，我们对所有 RoI-wise  操作采用轻头结构。我们在两个公共数据集（即 DOTA [37] 和 HRSC2016 [28]）上广泛测试和评估提出的 RoI  Transformer，并将其与最先进的方法进行比较，例如可变形 PS RoI 池 [ 5]。总之，我们的贡献有三方面：

- 我们提出了一个有监督的旋转 RoI 学习器，它是一个可学习的模块，可以将水平 RoI 转换为 RRoI。这种设计不仅可以有效缓解 RoI  与对象之间的错位，还可以避免为定向对象检测而设计的大量锚点。
- 我们设计了一个 Rotated Position Sensitive RoI Alignment  模块用于空间不变的特征提取，可以有效地促进对象分类和位置回归。该模块是使用 Light-head RoI-wise  操作时的关键设计，它可以提高效率和降低复杂性。
- 我们在几个公共大规模数据集上实现了最先进的性能，用于航空图像中的定向目标检测。实验还表明，所提出的 RoI Transformer  可以很容易地嵌入到不同的主干中，并显着提高检测性能。

# 2. Related work

## 2.1 Oriented Bounding Box Regression

检测定向对象是一般水平对象检测的扩展。任务是使用方向信息对对象进行定位和分类，主要使用基于区域提议的方法来解决。基于  HRoI 的方法 [15, 37] 通常使用正常的 RoI Warping 从 HRoI  中提取特征，并回归相对于地面实况的位置偏移。基于HRoI的方法存在区域特征和实例之间未对齐的问题。基于 RRoI 的方法 [30, 26] 通常使用  Rotated RoI Warping 从 RRoI 中提取特征，并回归相对于 RRoI 的位置偏移，这可以在一定程度上避免未对齐的问题。然而，基于 RRoI  的方法涉及生成大量的旋转提案。 [26] 采用 [27] 中的方法进行轮换提案。 SRBBS [27] 很难嵌入到神经网络中，这将花费额外的时间来生成旋转提案。  [30, 43, 41, 1] 在 RPN [32] 中使用了旋转锚的设计。然而，由于锚点数量（num scales×num aspect ratios×num  angle）的急剧增加，设计仍然很耗时。例如，一个位置有 3 × 5 × 6 = 90  个锚点。大量的anchor增加了网络中参数的计算，同时也降低了proposal和ground  truth的匹配效率。此外，由于存在大量冗余的旋转锚点，定向边界框（OBB）之间的直接匹配比水平边界框（HBB）之间的直接匹配更难。因此，在旋转锚点的设计中，[30,  24] 都使用了宽松的匹配策略。有一些 anchor 在任何 ground truth 上都没有达到 0.5 以上的 IoU，但它们被分配为 True  Positive 样本，这仍然会导致错位问题。在这项工作中，我们仍然使用水平锚点。不同之处在于，在生成 HRoI 时，我们通过轻量级全连接层将它们转换为  RRoI。基于这种策略，没有必要增加锚的数量。并且可以获得很多精确的  RRoI，这将促进匹配过程。所以我们直接使用OBB之间的IoU作为匹配标准，可以有效避免错位问题。

## 2.2 Spatial-invariant Feature Extraction

CNN  具有平移不变性，但在旋转和尺度变化上表现不佳。对于图像特征提取，提出了空间变换器[14]和可变形卷积[5]来模拟任意变形。它们是在没有额外监督的情况下从目标任务中学习的。对于区域特征提取，提出了可变形  RoI pooling [5]，这是通过对 RoI pooling 的采样网格进行偏移学习来实现的。与常规的 RoI 翘曲相比，它可以更好地模拟实例级别的变形  [8, 10, 4]。 STN  和可变形模块广泛用于场景文本和航空图像领域的识别[40,33,19,34,39]。对于航拍图像中的目标检测，旋转和尺度变化较多，但几乎没有非刚性变形。因此，我们的  RoI Transformer 只对刚性空间变换进行建模，它以 (dx, dy, dw, dh, dθ) 的格式学习。然而，与可变形的 RoI 池化不同，我们的  RoI Transformer 在地面实况的监督下学习偏移量。并且 RRoI 还可以用于进一步旋转边界框回归，这也有助于目标定位性能。

## 2.3 Light RoI-wise Operations

roi-wise  操作是两阶段算法效率的瓶颈，因为计算不是共享的。 Light-head R-CNN [17]  被提出来解决这个问题，通过使用更大的可分离卷积来获得细特征。它还采用 PS RoI pooling [4]  来进一步降低特征图的维数。在10维的池化特征上应用单个全连接层，可以显着提高两阶段算法的速度。在航拍图像中，存在实例数量很大的场景。例如，单个 1024 ×  1024 图像上可能有超过 800 个实例。我们的方法类似于可变形 RoI 池 [5]，其中 RoI 操作进行了两次。灯头设计也用于效率保证。

# 3. RoI transformer

在本节中，我们将详细介绍我们提出的  RoI Transformer，它包含两部分，RRoI Learner 和 RRoI Warping。 RRoI Learner 是一个 PS RoI  Align 后跟一个维度为 5 的全连接层，它回归了 Rotated Ground Truth (RGT) 相对于 HRoI 的偏移量。 RRoI  Warping 扭曲旋转区域特征以保持旋转不变性。对于端到端训练，这两层都是可区分的。架构如图2所示。

## 3.1 RRoI Learner

RRoI 学习器旨在从水平 RoI (HRoIs) 的特征图中学习旋转的 RoI (RRoI)。假定我们得到了  n 个用 {Hi} 表示的 HRoI，格式为 (x, y, w, h) 用于预测的 2D 位置、HRoI 的宽度和高度，对应的特征图可以表示为  {Fi}。由于在理想情况下每个 HRoI 都是 RRoI 的外部矩形，因此我们试图通过使用全连接层从每个特征图 Fi 推断 RRoI  的几何形状。我们首先给出相对于一般 RRoI 的偏移量的回归目标为
$$
\begin{aligned}
t_{x}^{*} &=\frac{1}{w_{r}}\left(\left(x^{*}-x_{r}\right) \cos \theta_{r}+\left(y^{*}-y_{r}\right) \sin \theta_{r}\right), \\
t_{y}^{*} &=\frac{1}{h_{r}}\left(\left(y^{*}-y_{r}\right) \cos \theta_{r}-\left(x^{*}-x_{r}\right) \sin \theta_{r}\right), \\
t_{w}^{*} &=\log \frac{w^{*}}{w_{r}}, \quad t_{h}^{*}=\log \frac{h^{*}}{h_{r}} \\
t_{\theta}^{*} &=\frac{1}{2 \pi}\left(\left(\theta^{*}-\theta_{r}\right) \quad \bmod 2 \pi\right)
\end{aligned}
$$
其中 $\left(x_{r}, y_{r}, w_{r}, h_{r}, \theta_{r}\right)$是一个堆叠向量，用于表示 RRoI 的位置、宽度、高度和方向，$\left(x^{*}, y^{*}, w^{*}, h^{*}, \theta^{*}\right)$ 是地面实况参数定向边界框（OBB）。 mod用于调整[0, 2π)中的角度偏移目标t∗θ，以方便计算。实际上，相对于 HRoI 的回归偏移目标是等式的一个特例。  (1) 如果 $\theta^{*}=\frac{3 \pi}{2} $ 。图 3 中举例说明了一般的相对偏移量。推导出方程。 需要将OBB的坐标从全局坐标系转换到局部坐标系（例如x1O1y1）。在数学上，全连接层为每个特征图 Fi 输出一个向量 (tx, ty, tw, th,  tθ)
$$
\boldsymbol{t}=\mathcal{G}(\mathcal{F} ; \Theta)
$$
其中  $\mathcal{G}$代表全连接层，Θ 是 $\mathcal{G}$的权重参数，F 是每个 HRoI 的特征图。

![](..\images\202203\21\1.png)

图 2. RoI Transformer 的架构。对于每个 HRoI，它都会传递给 RRoI 学习器。我们网络中的 RRoI 学习器是一个 PS RoI  Align，后跟一个维度为 5 的全连接层，该层回归 Rotated Ground Truth (RGT) 相对于 HRoI 的偏移量。 Box 解码器位于  RRoI Learner 的末尾，它将 HRoI 和偏移量作为输入，并输出解码后的 RRoI。然后将特征图和 RRoI 传递给 RRoI  翘曲以进行几何鲁棒特征提取。 RRoI Learner 和 RRoI warping 的组合形成了一个 RoI Transformer。然后将来自 RoI  Transformer 的几何稳健池化特征用于分类和 RRoI 回归。

在训练期间，我们必须匹配输入  HRoI 和定向边界框 (OBB) 的地面实况。为了提高效率，HRoI 和轴对齐边界框之间的匹配过程是在原始地面实况上进行的。一旦 HRoI 与 OBB  的基本事实相匹配，我们就直接根据方程式中的定义设置 t*。 (1)。我们对回归损失使用 Smooth L1 loss [9] 函数。对于每个前向传递中的预测  t，我们将其从偏移量解码为 RRoI 的参数。也就是说，我们提出的 RRoI 学习器可以从 HRoI 特征图 F 中学习 RRoI 的参数。

# 以下内容无

# motivation

水平的region proposal和物体不匹配，置信度和精度都会变差。

一些斜框算法：航拍图像的方向多样化，有限方向的RoI难以获取准确的RoI进行配对。但方向和尺度的增多会其在回归和分类的时候算法复杂性增大很多。

由于常规网络中用于对象检测的常规操作 [8] 对旋转和尺度变化的泛化有限，因此在设计 RoI 和相应的提取特征时需要一些方向和尺度不变。为此，已提出spatial transformer  [14] 和可变形卷积和 RoI 池化 [5]  来对几何变化进行建模。然而，它们主要是为一般几何变形而设计的，没有使用定向边界框标注。在航拍图像领域，只有刚性变形，有方向的边界框标注。因此，很自然地认为提取旋转不变区域特征并消除区域特征和对象之间的错位非常重要，特别是对于密集打包的对象。

# new structures

1. RRoi learner，学习从直框roi到旋转框roi的转换。
2. rotated position sensitive roi align 从旋转框rroi中提取旋转不变特征，用于对象的分类和位置回归。

进一步提高效率：

 所有的roi-wise操作采用light head结构。

# contribution

- 我们提出了一个有监督的旋转 RoI 学习器，它是一个可学习的模块，可以将水平 RoI 转换为 RRoI。这种设计不仅可以有效缓解 RoI  与对象之间的错位，还可以避免为定向对象检测而设计的大量锚点。
- 我们设计了一个 Rotated Position Sensitive RoI Alignment  模块用于空间不变的特征提取，可以有效地促进对象分类和位置回归。该模块是使用 Light-head RoI-wise  操作时的关键设计，它可以提高效率和降低复杂性。
- 我们在几个公共大规模数据集上实现了最先进的性能，用于航空图像中的定向目标检测。实验还表明，所提出的 RoI Transformer  可以很容易地嵌入到不同的主干中，并显着提高检测性能。

在hroi生成之后通过全连接层将其转换为rroi，在该策略下，不需要增加锚点。直接使用rroi之间的iou，能够避免错位。

